---
title: "Plotting audience postcodes, with functions"
author: "Laura Flenley"
date: "2025-01-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE, echo = FALSE, warnings = FALSE) #set wd to project folder

#include = TRUE: code outputs / graphs will show in html
#echo = FALSE: code won't be printed in markdown

```

```{r install packages, eval = FALSE}
#code for installing packages
install.packages("tidyverse")
install.packages("sf")
install.packages("shiny")
install.packages("ggmap")
install.packages("plotly")
install.packages("osmdata")

```

<!-- ### 2.  Load packages and data -->

**Dataset / Map data:** I have downloaded some datasets: 

- **'UK postcode boundary polygons'** from the **Open Door Logistics** website, which is described as 'reconstructed UK postcode polygons (January 2015) in Shapefile format'. There may be some terms and conditions to using this data that we need to be aware of.

- **'Indices of Multiple Deprivation'** from the **UK Government via Communities Open Data**, as part of the ArcGis Community Hub. This contains the indices of multiple deprivation as shapefiles.

- **'Code-point open'** from the **Ordinance Survey Data Hub**, which contains extra details of postcodes, not as shapefiles but as a csv datatable. 

```{r load packages & data subset data, include=FALSE}
#load packages
library(tidyverse)
library(sf)
library(dplyr)
library(stringr)
library(osmdata)
library(ggmap)

#load our functions script
source("functions/functions1.R")

#load the data into R, and name it
postcodes_sf<-read_sf("data/postcode_boundary_data/Distribution/Sectors.shp") #postcode shps
IMD_sf<-read_sf("data/multdep_2019/Indices_of_Multiple_Deprivation_(IMD)_2019/Indices_of_Multiple_Deprivation_(IMD)_2019.shp") #IMD shps
concert<-read_csv("data/concert_feedback.csv")


#to obtain all the codepoint postcode data in one: BEHOLD A FUNCTION
postcode_starts <- c("ox")  ##ADD HERE: ALL UNIQUE LETTER STARTS TO POSTCODES THAT YOU HAVE
#OR USE THIS IF YOU JUST WANT TO INCLUDE THEM ALL:
  #postcode_starts <- unique(concert$postcode_start)
postcodes_csv<-load_postcode_data(postcode_starts)

#transform data to correct crs
IMD_sf <- st_transform(IMD_sf, crs = 4326)
postcodes_sf <- st_transform(postcodes_sf, crs = 4326)

#subset the postcodes data for oxfordshire:
  ## Use dplyr and stringr to filter the postcodes data for rows with oxford postcodes: aka observations with 'OX' in them
oxonly_postcodes_sf <- postcodes_sf%>%
  filter(str_detect(name, regex("OX", ignore_case = TRUE)))


#subset the IMD data for oxfordshire:
oxonly_IMD_sf<-IMD_sf %>%
  filter(str_detect(LADnm, regex("oxford|vale of white horse|cherwell", ignore_case = TRUE)))


#subset the IMD data for a larger subset (WIP):
ox_IMD_sf<-IMD_sf %>%
  filter(str_detect(LADnm, regex("oxford|vale of white horse|cherwell|south buckingham|chiltern|wycombe|aylesbury vale|eastleigh|east hampshire|basingstoke and deane|fareham|gosport|^hart$|havant|New forest|portsmouth|rushmoor|southampton|test valley|winchester", ignore_case = TRUE)))


```

### Full Postcodes Plot

- Oxfordshire only

- area coloured by Indices of Multiple Deprivation (2019) for each lower-layer super output area (lighter = more deprived)

- Postcode sectors (eg. OX1 1) are shown as white boundaries

- audience members who gave full postcodes are shown as red points

- Dorchester Abbey shown as yellow point

```{r data handling before plotting}

#we need to make a table containing postcode, number of attendees, latitude and longitude of that postcode - in order to plot it. so we'll use a function
head(concert)
head(postcodes_csv)


source("functions/functions1.R")
full_postcodes_oxfordshire <- construct_full_postcode_info(concert, postcode_starts, postcodes_csv)
full_postcodes_oxfordshire_plot <- plot_individual_postcodes(oxonly_IMD_sf, oxonly_postcodes_sf, full_postcodes_oxfordshire)


bbox <- c(left = -1.7, bottom = 51.5, right = -0.9, top = 52.2) # Oxfordshire bounds
plot_xlim = c(-1.7, -0.85)
plot_ylim = c(51.5, 52.2)
plot1 <- plot_individual_postcodes_names(oxonly_IMD_sf, oxonly_postcodes_sf, full_postcodes_oxfordshire, bbox_coords, plot_xlim, plot_ylim)
print

#trying a smaller map
smaller_xlim = c(-1.45, -1.08)
smaller_ylim = c(51.58, 51.8)
plot2 <- plot_individual_postcodes_names(oxonly_IMD_sf, oxonly_postcodes_sf, full_postcodes_oxfordshire, bbox_coords, smaller_xlim, smaller_ylim)


```

```{r, fig.height = 6*3, fig.width = 6*3}


#trying a smaller map
smaller_xlim = c(-1.45, -1.08)
smaller_ylim = c(51.58, 51.8)
plot2 <- plot_individual_postcodes_names_villages(oxonly_IMD_sf, oxonly_postcodes_sf, full_postcodes_oxfordshire, bbox_coords, smaller_xlim, smaller_ylim)


```


